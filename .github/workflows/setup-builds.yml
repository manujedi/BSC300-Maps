name: start map builds

on: 
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"
    - cron: "0 0 15 * *"

jobs:

  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v5 

      - name: edit Readme
        run: |
          sed -i "1s/.*/# Last Map Update: $(date)/"  README.md
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "Update map creation date"
          git push origin master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-osmsis-cache:
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v5

      - name: omsis-cache
        uses: actions/cache/restore@v4
        id: cache
        with:
          path: osmosis
          key: osmsis-cache

      - name: omsis
        if: steps.cache.outputs.cache-hit != 'true'
        run: sh setup_env.sh

      - uses: actions/cache/save@v4
        if: steps.cache.outputs.cache-hit != 'true'
        with:
          path: osmosis
          key: osmsis-cache

  cleanup-old-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: cleanup
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh run list --repo ${{ github.repository }} --limit 1000 --json databaseId -q '.[].databaseId' | while read id; do gh run delete "$id" --repo ${{ github.repository }} || continue; done
